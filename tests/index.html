<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gig Platform Prototype</title>
</head>
<body>
  <h1>Gig Platform Prototype</h1>

  <!-- Registration Form -->
  <section id="registerSection">
    <h2>Register</h2>
    <form id="registerForm">
      <input type="text" id="regName" placeholder="Name" required /><br/>
      <input type="email" id="regEmail" placeholder="Email" required /><br/>
      <input type="password" id="regPassword" placeholder="Password" required /><br/>
      <button type="submit">Register</button>
    </form>
    <p id="registerMsg"></p>
  </section>

  <!-- Login Form -->
  <section id="loginSection">
    <h2>Login</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required /><br/>
      <input type="password" id="loginPassword" placeholder="Password" required /><br/>
      <button type="submit">Login</button>
    </form>
    <p id="loginMsg"></p>
  </section>

  <!-- Profile Section -->
  <section id="profileSection" style="display:none;">
    <h2>My Profile</h2>
    <div id="profileInfo"></div>
    <h3>Update Profile</h3>
    <form id="updateProfileForm">
      <input type="text" id="updateName" placeholder="Name" /><br/>
      <textarea id="updateBio" placeholder="Bio"></textarea><br/>
      <input type="text" id="updateLocation" placeholder="Location" /><br/>
      <input type="text" id="updatePortfolio" placeholder="Portfolio" /><br/>
      <button type="submit">Update Profile</button>
    </form>
    <p id="profileMsg"></p>
  </section>

  <!-- Create Gig Section -->
  <section id="gigSection" style="display:none;">
    <h2>Create Gig</h2>
    <form id="createGigForm" enctype="multipart/form-data">
      <input type="text" id="gigTitle" placeholder="Gig Title" required /><br/>
      <textarea id="gigDescription" placeholder="Description" required></textarea><br/>
      <input type="number" id="gigPrice" placeholder="Price" required /><br/>
      <input type="file" id="gigImage" accept="image/*" /><br/>
      <button type="submit">Post Gig</button>
    </form>
    <p id="gigMsg"></p>
  </section>

  <!-- Submit Bid Section -->
  <section id="bidSection" style="display:none;">
    <h2>Submit Bid</h2>
    <form id="createBidForm" enctype="multipart/form-data">
      <input type="text" id="bidGigId" placeholder="Gig ID" required /><br/>
      <input type="number" id="bidAmount" placeholder="Bid Amount" required /><br/>
      <input type="file" id="bidAttachment" /><br/>
      <button type="submit">Submit Bid</button>
    </form>
    <p id="bidMsg"></p>
  </section>

  <!-- Send Message Section -->
  <section id="messageSection" style="display:none;">
    <h2>Send Message</h2>
    <form id="sendMessageForm" enctype="multipart/form-data">
      <input type="text" id="msgGigId" placeholder="Gig ID" required /><br/>
      <input type="text" id="msgBidId" placeholder="Bid ID" required /><br/>
      <textarea id="msgContent" placeholder="Message Content"></textarea><br/>
      <input type="file" id="msgAttachment" /><br/>
      <button type="submit">Send Message</button>
    </form>
    <p id="messageMsg"></p>
  </section>

  <script>
    const API_BASE = 'http://localhost:4000/api';

    // Utility to get JWT token
    function getToken() {
      return localStorage.getItem('token');
    }

    // Utility to set Authorization headers
    function authHeaders() {
      return {
        'Authorization': 'Bearer ' + getToken()
      };
    }

    // Register User
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('regName').value;
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      const res = await fetch(API_BASE + '/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, password })
      });
      const data = await res.json();
      document.getElementById('registerMsg').innerText = data.message || data.error;
    });

    // Login User
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const res = await fetch(API_BASE + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if(data.token) {
        localStorage.setItem('token', data.token);
        document.getElementById('loginMsg').innerText = 'Login successful!';
        // Show sections after login
        document.getElementById('profileSection').style.display = 'block';
        document.getElementById('gigSection').style.display = 'block';
        document.getElementById('bidSection').style.display = 'block';
        document.getElementById('messageSection').style.display = 'block';
        // Load user profile
        loadUserProfile();
      } else {
        document.getElementById('loginMsg').innerText = data.error;
      }
    });

    // Load Profile Info
    async function loadUserProfile() {
      // Assuming the token contains userId in payload. If not, adjust accordingly.
      const token = getToken();
      const payload = JSON.parse(atob(token.split('.')[1]));
      const userId = payload.userId;
      const res = await fetch(API_BASE + '/users/' + userId);
      const user = await res.json();
      document.getElementById('profileInfo').innerText = JSON.stringify(user, null, 2);
    }

    // Update Profile
    document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = getToken();
      const payload = JSON.parse(atob(token.split('.')[1]));
      const userId = payload.userId;
      const name = document.getElementById('updateName').value;
      const bio = document.getElementById('updateBio').value;
      const location = document.getElementById('updateLocation').value;
      const portfolio = document.getElementById('updatePortfolio').value;

      const res = await fetch(API_BASE + '/users/' + userId, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...authHeaders()
        },
        body: JSON.stringify({ name, bio, location, portfolio })
      });
      const data = await res.json();
      document.getElementById('profileMsg').innerText = data.message || data.error;
      loadUserProfile();
    });

    // Create Gig
    document.getElementById('createGigForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData();
      formData.append('title', document.getElementById('gigTitle').value);
      formData.append('description', document.getElementById('gigDescription').value);
      formData.append('price', document.getElementById('gigPrice').value);
      if(document.getElementById('gigImage').files[0]) {
        formData.append('gigImage', document.getElementById('gigImage').files[0]);
      }
      const res = await fetch(API_BASE + '/gigs', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + getToken()
        },
        body: formData
      });
      const data = await res.json();
      document.getElementById('gigMsg').innerText = data.message || data.error;
    });

    // Submit Bid
    document.getElementById('createBidForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData();
      formData.append('gig_id', document.getElementById('bidGigId').value);
      formData.append('amount', document.getElementById('bidAmount').value);
      if(document.getElementById('bidAttachment').files[0]) {
        formData.append('bidAttachment', document.getElementById('bidAttachment').files[0]);
      }
      const res = await fetch(API_BASE + '/bids', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + getToken()
        },
        body: formData
      });
      const data = await res.json();
      document.getElementById('bidMsg').innerText = data.message || data.error;
    });

    // Send Message
    document.getElementById('sendMessageForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData();
      formData.append('gigId', document.getElementById('msgGigId').value);
      formData.append('bidId', document.getElementById('msgBidId').value);
      formData.append('content', document.getElementById('msgContent').value);
      if(document.getElementById('msgAttachment').files[0]) {
        formData.append('messageAttachment', document.getElementById('msgAttachment').files[0]);
      }
      const res = await fetch(API_BASE + '/messages', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + getToken()
        },
        body: formData
      });
      const data = await res.json();
      document.getElementById('messageMsg').innerText = data.message || data.error;
    });
  </script>
</body>
</html>
